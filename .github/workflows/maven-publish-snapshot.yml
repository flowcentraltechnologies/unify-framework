# This workflow will build and release unify framework snapshot

name: Release Unify Framework Snapshot

on:
  push:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 1.8
      uses: actions/setup-java@v3
      with:
        java-version: 8
        distribution: 'temurin'
        cache: maven
        gpg-private-key: ${{ secrets.MVN_GPG_SECRET_KEY }}
        gpg-passphrase: ${{secrets.MVN_GPG_PASSPHRASE}}
        
    - name: Setup Maven Version
      uses: s4u/setup-maven-action@v1.2.1
      with:
        java-version: 8
        maven-version: 3.5.4
        
    - name: Reconfigure Maven Settings
      uses: whelk-io/maven-settings-xml-action@v20
      with:
        servers: |
          [{
              "id": "sonatype-nexus-snapshots",
              "username": "${{ secrets.REPO_USERNAME }}",
              "password": "${{ secrets.REPO_PASSWORD }}"
          }] 
        repositories: |
          [{
              "id": "sonatype-nexus-snapshots",
              "name": "Sonatype Nexus Snapshots",
              "url": "https://oss.sonatype.org/content/repositories/snapshots/",
              "releases": {
                "enabled": "false"
              },
              "snapshots": {
                "enabled": "true"
              }
          }] 
       
    - name: Extract Project Version
      id: project
      run: echo ::set-output name=version::$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
       
    - name: Deploy Snapshot with Maven
      if:  ${{ endsWith(steps.project.outputs.version, '-SNAPSHOT') }}
      run: mvn clean deploy -B -DrepoDeployMode=true
